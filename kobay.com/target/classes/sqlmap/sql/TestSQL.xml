<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="searchSpace">
	<typeAlias alias="testVO" type="kobay.com.service.TestVO"/>
	<typeAlias alias="searchVO" type="kobay.com.search.SearchVO"/>
	<typeAlias alias="egovMap" type="egovframework.rte.psl.dataaccess.util.EgovMap"/>
	<typeAlias alias="pageVO" type="kobay.com.cmmn.PageVO"/>
	
	<select id="test.getDept" resultClass="testVO">
		select deptno, dname, loc from dept where deptno=#deptno#
	</select>
	
	
	<!-- SearchList -->
	<select id="search.getList" parameterClass="pageVO" resultClass="egovMap">
		SELECT A.* FROM (
			SELECT ROWNUM RN, B.* FROM (
				SELECT  k.auctionUnq, 
	                to_char(k.sdate, 'yyyy-mm-dd')sDate, 
	                to_char(k.eDate, 'yyyy-mm-dd')eDate,
	                k.aucTitle,
	                k.aucImageMain, 
	                k.aucImageSub1, 
	                k.aucImageSub2, 
	                k.aucImageSub3, 
	                k.ePrice, 
	                k.sellerName, 
	                k.aucStatus,
	                k.aucdetail,
	                (select max(bidprice) from AUCTIONBID where AUCTIONUNQ =  K.AUCTIONUNQ)price,
	                (select count(*) from AUCTIONBID where AUCTIONUNQ =  K.AUCTIONUNQ)bids,
	                (select ctgnm from auctionctg where ctgcd = k.lctg)lctg,
        			(select ctgnm from auctionctg where ctgcd = k.mctg)mctg
				FROM    KOBAYAUCTION K, (select distinct(auctionunq) from auctionbid) A
				WHERE  K.AUCTIONUNQ = a.auctionunq 
				AND (
	           			AUCTITLE LIKE '%' || #searchKeyword# || '%' 
	            	OR 
	            		AUCDETAIL LIKE '%' || #searchKeyword# || '%' 
	            	OR 
	            		SELLERNAME LIKE '%' || #searchKeyword# || '%' 
					OR 
	               		(select ctgnm from auctionctg where ctgcd = k.lctg) LIKE '%' || #searchKeyword# || '%' 
	            	OR 
	                	(select ctgnm from auctionctg where ctgcd = k.mctg) LIKE '%' || #searchKeyword# || '%'
	        	)
				<isNotNull property="orderCondition">
					<isEqual property="orderCondition" compareValue="best">
						ORDER BY bids DESC ) B 
					</isEqual>
					<isEqual property="orderCondition" compareValue="close">
						ORDER BY abs( TO_DATE( edate,'YYYY-MM-DD') - TO_DATE( to_char(sysdate, 'YYYY-mm-dd'),'YYYY-MM-DD')) asc ) B 
					</isEqual>
					<isEqual property="orderCondition" compareValue="recent">
						ORDER BY abs( TO_DATE( sdate,'YYYY-MM-DD') - TO_DATE( to_char(sysdate, 'YYYY-mm-dd'),'YYYY-MM-DD')) asc ) B 
					</isEqual>
					<isEqual property="orderCondition" compareValue="lowprice">
						ORDER BY price asc ) B 
					</isEqual>
					<isEqual property="orderCondition" compareValue="highprice">
						ORDER BY price DESC ) B  
					</isEqual>
					<isEqual property="orderCondition" compareValue="">
						ORDER BY auctionUnq DESC ) B 
					</isEqual>
				</isNotNull>
				<isNull property="orderCondition">
					ORDER BY auctionUnq DESC ) B 
				</isNull>	
				) A
				WHERE RN >= 1 AND RN <![CDATA[<=]]> 100 
				AND TO_DATE( edate,'YYYY-MM-DD') - TO_DATE( to_char(sysdate, 'YYYY-mm-dd'),'YYYY-MM-DD') > 0
		 
		 <!--  WHERE RN >= #firstIndex# AND RN <![CDATA[<=]]> #lastIndex#  -->
	</select>
	
	
	<!-- 각 대메뉴 카테고리별로 가져오기  -->
	<select id="search.getMCtgList" parameterClass="pageVO" resultClass="java.lang.Integer">
		SELECT  count(*)
		FROM    KOBAYAUCTION K, (select distinct(auctionunq) from auctionbid) A
		WHERE   K.AUCTIONUNQ = a.auctionunq
		AND (
       			AUCTITLE LIKE '%' || #searchKeyword# || '%' 
        	OR 
        		AUCDETAIL LIKE '%' || #searchKeyword# || '%' 
        	OR 
        		SELLERNAME LIKE '%' || #searchKeyword# || '%' 
			OR 
           		(select ctgnm from auctionctg where ctgcd = k.lctg) LIKE '%' || #searchKeyword# || '%' 
        	OR 
            	(select ctgnm from auctionctg where ctgcd = k.mctg) LIKE '%' || #searchKeyword# || '%'
	        	)
		AND
		        (select ctgcd from auctionctg where ctgcd = k.mctg) LIKE '%' || #mCtgcd#  || '%' 
		AND TO_DATE( to_char(k.eDate, 'yyyy-mm-dd'),'YYYY-MM-DD') - TO_DATE( to_char(sysdate, 'YYYY-mm-dd'),'YYYY-MM-DD') > 0

	</select>
	
	<select id="search.selectLCtgList" resultClass="egovMap">
		SELECT 
			A.ctgcd,
			A.ctgnm
			(SELECT  count(*)
			FROM    KOBAYAUCTION K, (select distinct(auctionunq) from auctionbid) A
			WHERE   K.AUCTIONUNQ = a.auctionunq
			AND (
	       			AUCTITLE LIKE '%' || #searchKeyword# || '%' 
	        	OR 
	        		AUCDETAIL LIKE '%' || #searchKeyword# || '%' 
	        	OR 
	        		SELLERNAME LIKE '%' || #searchKeyword# || '%' 
				OR 
	           		(select ctgnm from auctionctg where ctgcd = k.lctg) LIKE '%' || #searchKeyword# || '%' 
	        	OR 
	            	(select ctgnm from auctionctg where ctgcd = k.mctg) LIKE '%' || #searchKeyword# || '%'
		        	)
			AND
			        (select ctgcd from auctionctg where ctgcd = k.mctg) LIKE '%' || #mCtgcd#  || '%' 
			AND TO_DATE( to_char(k.eDate, 'yyyy-mm-dd'),'YYYY-MM-DD') - TO_DATE( to_char(sysdate, 'YYYY-mm-dd'),'YYYY-MM-DD') > 0)		
 		FROM  
 			AUCTIONCTG A
 		WHERE 1=1
 		AND
 			LENGTH(a.ctgcd) <![CDATA[<]]> 4
 		
	</select>
	
	<select id="search.selectMCtgList" parameterClass="pageVO" resultClass="egovMap">
		SELECT 
		    distinct(a.ctgcd),
		    a.ctgnm,
		    (SELECT count(*) 
		    FROM  
		            KOBAYAUCTION k
		    WHERE ctgcd = k.mctg
		    AND (
		        k.AUCTITLE LIKE '%' || #searchKeyword# || '%' 
		        OR 
		        k.AUCDETAIL LIKE '%' || #searchKeyword# || '%' 
		        OR 
		            k.SELLERNAME LIKE '%' || #searchKeyword# || '%' 
		        OR 
		            (select ctgnm from auctionctg where ctgcd = k.lctg) LIKE '%' || #searchKeyword# || '%' 
		        OR 
		            (select ctgnm from auctionctg where ctgcd = k.mctg) LIKE '%' || #searchKeyword# || '%'
		    )
		    AND TO_DATE( to_char(k.eDate, 'yyyy-mm-dd'),'YYYY-MM-DD') - TO_DATE( to_char(sysdate, 'YYYY-mm-dd'),'YYYY-MM-DD') > 0)count
		FROM AUCTIONCTG a
		WHERE ctgcd like #ctgcd# || '_%'
	</select>
	
	
	
	<select id="search.lCtgCodes" resultClass="egovMap">
			SELECT 
				ctgcd
	 		FROM  
	 			AUCTIONCTG a
	 		WHERE 1=1
	 		AND
	 			LENGTH(a.ctgcd) <![CDATA[<]]> 4
	</select>
	
	
	<select id="search.mctgCodes" resultClass="egovMap">
		select 
			ctgcd
		from
			AUCTIONCTG a
		where LENGTH(a.ctgcd) <![CDATA[>=]]> 4
	</select>

</sqlMap>